
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://www.haydenhaslam.com/newcustomimage/">
      
      
      
      
      <link rel="icon" href="../images/HKH.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.28">
    
    
      
        <title>May 3, 2024 - HaydenHaslam.com</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#may-3-2024" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="HaydenHaslam.com" class="md-header__button md-logo" aria-label="HaydenHaslam.com" data-md-component="logo">
      
  <img src="../images/HKH.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HaydenHaslam.com
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              May 3, 2024
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Hayden-Haslam/Hayden-Haslam.github.io.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Hayden-Haslam.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../posts/" class="md-tabs__link">
        
  
    
  
  Posts

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="HaydenHaslam.com" class="md-nav__button md-logo" aria-label="HaydenHaslam.com" data-md-component="logo">
      
  <img src="../images/HKH.png" alt="logo">

    </a>
    HaydenHaslam.com
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Hayden-Haslam/Hayden-Haslam.github.io.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Hayden-Haslam.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../posts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Posts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#current-project-making-a-script-to-automate-wim-extraction-and-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Current Project: Making a script to automate wim extraction and setup
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="may-3-2024">May 3, 2024<a class="headerlink" href="#may-3-2024" title="Permanent link">&para;</a></h1>
<h2 id="current-project-making-a-script-to-automate-wim-extraction-and-setup">Current Project: Making a script to automate wim extraction and setup<a class="headerlink" href="#current-project-making-a-script-to-automate-wim-extraction-and-setup" title="Permanent link">&para;</a></h2>
<p><strong>Problem to solve:</strong> I need to recreate Windows images every quarter for
security and PCI compliance reasons. My current solution to this was to mount my
existing <code>install.wim</code> and boot it into audit mode, make whatever changes are
needed, and reapply any sysprep stuff, and recapture. This became very tedious
very fast with most of the steps being done manually.</p>
<p><strong>Goal:</strong> I want to create a nice script to do most of the steps for me. I will
out line it first with my rough order and where I think the commands need to go
for this process. Then I will slowly go through and actually uncomment the
commands and make the thing real!</p>
<p><strong>Update #1:</strong> As I've been working through this, I've made a lot of progress on
the logic of the script. I have also been trying to incorporate use of
<code>Write-Verbose</code> to leverage some verbose output for troubleshoot purposes, but I
am still a little confused on how it exactly works. So for now, disregard the
excessive amount for <code>Write-Verbose</code> lines.</p>
<p><strong>Update #2:</strong> Ive made a lot of changes here. In the future, I will try to do a
better job of showing my old way and new way side by side instead of replacing
everything at once. But I started practicing the use of Advanced Functions and
creating my own cmdlets. I have converted this script into the <code>New-CustomImage</code>
cmdlet. I have made two parameters for the two locations that will be needed on
the computer. My goal is to have a network location that is accessible to
everyone running my script. I set that location as default parameter value, but
they can change it if they wish. Same goes for the local location on their
computer where the actual image building/manipulation will happen.</p>
<p>Since the <code>Mount-WindowsImage</code> cmdlet requires Administrator privileges, I have
added <code>#requires -RunAsAdministrator</code> to my function as well. I still have much
more to do with this script but I feel like I am making very good progress.</p>
<div class="highlight"><pre><span></span><code><span class="c">#requires -RunAsAdministrator</span>

<span class="k">function</span> <span class="nb">New-CustomImage</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">CmdletBinding</span><span class="p">()]</span>
    <span class="k">param</span><span class="p">(</span>
        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">HelpMessage</span> <span class="p">=</span> <span class="s2">&quot;Enter the location on you local computer where you want to make the working directory.&quot;</span><span class="p">)]</span>
        <span class="no">[string]</span> <span class="nv">$LocalDirectory</span> <span class="p">=</span> <span class="s1">&#39;C:\zzz&#39;</span><span class="p">,</span>
        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">HelpMessage</span> <span class="p">=</span> <span class="s2">&quot;Enter the location that you want to pull the working files from.&quot;</span><span class="p">)]</span>
        <span class="no">[string]</span> <span class="nv">$NetworkLocation</span> <span class="p">=</span> <span class="s1">&#39;C:\VM\workingdirctoryshare&#39;</span>
        <span class="c">#[Parameter(Mandatory)]</span>
        <span class="c">#[pscredential] $Credentials</span>
    <span class="p">)</span>

    <span class="c"># Write-Verbose -Message &quot;[ $((Get-Date).TimeOfDay.ToString()) ]&quot;</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Starting Script.&quot;</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Setting Working Directory to $LocalDirectory.&quot;</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Testing if $LocalDirectory exists.&quot;</span>
    <span class="k">if</span> <span class="p">(!(</span><span class="nb">Test-Path</span> <span class="n">-Path</span> <span class="nv">$LocalDirectory</span> <span class="n">-PathType</span> <span class="n">Any</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] $LocalDirectory does not exist, creating now.&quot;</span>
        <span class="c">#New-Item -Path &#39;C:\&#39; -Name &#39;workingdirectory&#39; -ItemType Directory</span>
        <span class="nb">New-Item</span> <span class="n">-ItemType</span> <span class="n">Directory</span> <span class="n">-Path</span> <span class="nv">$LocalDirectory</span>
        <span class="nb">Write-Warning</span> <span class="n">-Message</span> <span class="s2">&quot;The workingdirectory folder was not present. It has now been created.&quot;</span>
    <span class="p">}</span>

    <span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="nv">$NetworkLocation</span><span class="p">\*</span> <span class="n">-Destination</span> <span class="nv">$LocalDirectory</span> <span class="n">-Recurse</span>

    <span class="nv">$ISOLocation</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Item</span> <span class="n">-Path</span> <span class="nv">$LocalDirectory</span><span class="s1">&#39;\iso\*.iso&#39;</span><span class="p">).</span><span class="n">FullName</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Setting ISO location: $ISOLocation.&quot;</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Testing if ISO exists.&quot;</span>
    <span class="k">if</span> <span class="p">(!(</span><span class="nb">Test-Path</span> <span class="n">-Path</span> <span class="nv">$ISOLocation</span> <span class="n">-PathType</span> <span class="n">Leaf</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] ISO does not exist, display Warning and exit.&quot;</span>
        <span class="nb">Write-Warning</span> <span class="n">-Message</span> <span class="s2">&quot;Iso file is missing. Copy SW_DVD9_WIN_ENT_LTSC_2021_64BIT_English_MLF_X22-84414.ISO into C:\workingdirectory\iso and restart script.&quot;</span>
        <span class="k">Return</span>
    <span class="p">}</span>

    <span class="nv">$DriverFolder</span> <span class="p">=</span> <span class="nv">$LocalDirectory</span><span class="p">+</span><span class="s1">&#39;\Drivers&#39;</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Setting Driver folder location: $DriverFolder.&quot;</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Testing if Driver folder exists.&quot;</span>
    <span class="k">if</span> <span class="p">(!(</span><span class="nb">Test-Path</span> <span class="n">-Path</span> <span class="nv">$DriverFolder</span> <span class="n">-PathType</span> <span class="n">Any</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] $DriverFolder does not exits, creating now.&quot;</span>
        <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="nv">$LocalDirectory</span><span class="s1">&#39;\&#39;</span> <span class="n">-Name</span> <span class="s1">&#39;Drivers&#39;</span> <span class="n">-ItemType</span> <span class="n">Directory</span>
        <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Display Warning and exit.&quot;</span>
        <span class="nb">Write-Warning</span> <span class="n">-Message</span> <span class="s2">&quot;It looks like the driver folder is empty, add drivers and restart script&quot;</span>
        <span class="k">Return</span>
    <span class="p">}</span>

    <span class="c"># Mount iso file</span>
    <span class="nv">$LocationInfo</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Mount-DiskImage</span> <span class="n">-ImagePath</span> <span class="nv">$ISOLocation</span> <span class="n">-PassThru</span> <span class="p">|</span> <span class="nb">Get-Volume</span><span class="p">)</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Mounting ISO for wim extraction.&quot;</span>
    <span class="nv">$DriveLetter</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$LocationInfo</span><span class="p">).</span><span class="n">DriveLetter</span><span class="p">+</span><span class="s1">&#39;:\&#39;</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] ISO mounted at Driver Letter: $DriveLetter&quot;</span>
    <span class="nv">$DevicePath</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$LocationInfo</span> <span class="p">|</span> <span class="nb">Get-DiskImage</span><span class="p">).</span><span class="n">DevicePath</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] ISO mounted at Device Location: $DevicePath&quot;</span>
    <span class="nv">$WimName</span> <span class="p">=</span> <span class="s1">&#39;Win10Enterprise.wim&#39;</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Setting extracted wim name: $WimName&quot;</span>

    <span class="c"># Extract LTSC Edition from install.wim in sources directory to working directory</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Extracting Windows 10 LTSC version from install.wim to $LocalDirectory&quot;</span>
    <span class="n">Dism</span> <span class="p">/</span><span class="nb">Export-Image</span> <span class="p">/</span><span class="n">SourceImageFile</span><span class="p">:</span><span class="nv">$DriveLetter</span><span class="p">\</span><span class="n">sources</span><span class="p">\</span><span class="n">install</span><span class="p">.</span><span class="n">wim</span> <span class="p">/</span><span class="n">SourceIndex</span><span class="p">:</span><span class="n">1</span> <span class="p">/</span><span class="n">DestinationImageFile</span><span class="p">:</span><span class="nv">$LocalDirectory</span><span class="p">\</span><span class="n">iso</span><span class="p">\</span><span class="nv">$WimName</span>

    <span class="c"># Unmount iso file</span>
    <span class="nb">Write-Verbose</span> <span class="n">-Message</span> <span class="s2">&quot;[ </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">TimeOfDay</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span><span class="s2"> ] Dismount ISO file from $DevicePath&quot;</span>
    <span class="nb">Dismount-DiskImage</span> <span class="n">-DevicePath</span> <span class="nv">$DevicePath</span>

    <span class="c"># Rename the wim index to our own thing</span>
        <span class="c"># Using dism run below</span>
        <span class="c"># Imagex /info &quot;&lt;PATH TO IMAGE&gt;&quot; &lt;Index Number&gt; &quot;&lt;NEW IMAGE NAME&gt;&quot; &quot;&lt;NEW IMAGE DESCRIPTION&gt;&quot;</span>
        <span class="c"># Impossible unless ran from the Deployment tools utility</span>

    <span class="c"># Mount wim file</span>
    <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="nv">$LocalDirectory</span> <span class="n">-Name</span> <span class="s1">&#39;MountFolder&#39;</span> <span class="n">-ItemType</span> <span class="n">Directory</span>
    <span class="nv">$MountFolder</span> <span class="p">=</span> <span class="nv">$LocalDirectory</span><span class="p">+</span><span class="s1">&#39;\MountFolder&#39;</span>
    <span class="nv">$WimLocation</span> <span class="p">=</span> <span class="nv">$LocalDirectory</span><span class="p">+</span><span class="s1">&#39;\iso\&#39;</span><span class="p">+</span><span class="nv">$WimName</span>
    <span class="nb">Mount-WindowsImage</span> <span class="n">-ImagePath</span> <span class="nv">$WimLocation</span> <span class="n">-Index</span> <span class="n">1</span> <span class="n">-Path</span> <span class="nv">$MountFolder</span>

    <span class="c"># Inject device drivers</span>
    <span class="n">dism</span> <span class="p">/</span><span class="n">Image</span><span class="p">:</span><span class="nv">$MountFolder</span> <span class="p">/</span><span class="nb">Add-Driver</span> <span class="p">/</span><span class="n">Driver</span><span class="p">:</span><span class="nv">$DriverFolder</span> <span class="p">/</span><span class="n">Recurse</span>

    <span class="cm">&lt;# Windows Updates from WSUS</span>
<span class="cm">        # Set Server</span>
<span class="cm">        $WSUSServer = &#39;PC01.lab.test&#39; # eventually on Legend</span>
<span class="cm">        # Set OS type</span>
<span class="cm">        $OSName = &#39;Windows 10 LTSB&#39; # Might need to fix</span>

<span class="cm">        # Install Update tools</span>
<span class="cm">        Install-WindowsFeature UpdateServices-API</span>

<span class="cm">        # Set folder for downloading updates</span>
<span class="cm">        $UpdateFolder = New-Item -Path $LocalDirectory -Name &#39;Updates&#39; -ItemType Directory</span>

<span class="cm">        # Connect to WSUS server</span>
<span class="cm">        $WSUSConnection = Get-WsusServer -Name $WSUSServer -PortNumber 8530</span>
<span class="cm">        $AllUpdates = $WSUSConnection.GetUpdates()</span>

<span class="cm">        $OSUpdates = $AllUpdates | Where-Object {$OSName -in $_.ProductTitles -and $_.IsApproved -eq $true -and $_.IsSuperseded -eq $false}</span>

<span class="cm">        foreach($Update in $OSUpdates) {</span>
<span class="cm">            $CabURIs = $Update.GetInstallableItems() | Select-Object -ExpandProperty Files | Where-Object {$_.Type -eq &#39;SelfContained&#39;} | Select-Object -ExpandProperty FileUri | Select-Object -ExpandProperty AbsoluteUri</span>
<span class="cm">            foreach($CabURI in $CabURIs) {</span>
<span class="cm">                # $CabFile = $CabURI | Split-Path -Leaf</span>
<span class="cm">                $CabPath = $CabURI.Replace(&#39;/&#39;,&#39;\&#39;).Replace(&#39;http:&#39;,&#39;&#39;).Replace(&#39;:&#39;,&#39;&#39;).Replace(&#39;:8530&#39;,&#39;\C$&#39;).Replace(&#39;Content&#39;,&#39;WSUS\WsusContent&#39;)</span>
<span class="cm">                Copy-Item -Path $CabPath -Destination $UpdateFolder</span>
<span class="cm">            }</span>
<span class="cm">        }</span>

<span class="cm">        $UpdateFiles = Get-ChildItem $UpdateFolder | Select-Object -ExpandProperty FullName</span>

<span class="cm">        foreach ($AvailableUpdate in $UpdateFiles) {</span>
<span class="cm">            Add-WindowsPackage -PackagePath $AvailableUpdate -Path $MountFolder</span>
<span class="cm">        }</span>
<span class="cm">    #&gt;</span>

    <span class="c"># Make Audit Mode answer file</span>
        <span class="c"># To configure Windows to boot to audit mode, add the Microsoft-Windows-Deployment | Reseal | Mode = audit</span>
        <span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="nv">$LocalDirectory</span><span class="s1">&#39;\iso\unattend.xml&#39;</span> <span class="n">-Destination</span> <span class="nv">$MountFolder</span><span class="s1">&#39;\Windows\System32\Sysprep&#39;</span>
        <span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="nv">$LocalDirectory</span><span class="s1">&#39;\iso\CustomOOBE&#39;</span> <span class="n">-Destination</span> <span class="nv">$MountFolder</span><span class="s1">&#39;\Windows\System32\Sysprep&#39;</span> <span class="n">-Recurse</span>
        <span class="c"># Run script on first time start up</span>
            <span class="c"># Install-Module -Name PSWindowsUpdate</span>
            <span class="c"># Get-WindowsUpdate -AcceptAll</span>

    <span class="c"># Copy sysprep files into sysprep folder in image</span>
        <span class="c"># Copy-Item</span>

    <span class="c"># Unmount wim file</span>
    <span class="nb">Dismount-WindowsImage</span> <span class="n">-path</span> <span class="nv">$MountFolder</span> <span class="n">-save</span>

    <span class="c"># Rename wim file</span>
        <span class="c"># Rename-File -Path &lt;path to install.wim&gt; -NewName &lt;New Name of wim&gt;</span>

    <span class="c"># Hyper-V automated setup</span>
        <span class="c"># Build Virtual Machine</span>
        <span class="c"># ? Mount VHD </span>
        <span class="c"># $vhdfile = $LocalDirectory+&#39;\iso\temp.vhdx&#39;</span>
        <span class="c"># New-VHD -Path $vhdfile -Dynamic -SizeBytes 30GB | Mount-VHD -Passthru | Initialize-Disk -Passthru -Confirm:$false</span>
        <span class="c"># $disknumber = (Get-DiskImage -ImagePath $vhdfile | Get-Disk).Number</span>
        <span class="c"># ? Run Diskpart commands to format the drive correctly</span>
        <span class="c"># ? Expand-WindowsImage and &lt;cmd.exe /c &quot;bcdboot W:\Windows /s S: /f ALL&quot;&gt; to apply wim to vhd drive</span>
        <span class="c"># ? Unmount vhd drive</span>
        <span class="c"># ? Assign vhd to Virtual Machine</span>
        <span class="c"># ? Start Virtual Machine</span>

    <span class="c"># Boot Virtual Machine</span>
        <span class="c"># Audit Mode boots automatically and runs Startup script</span>

    <span class="c"># In startup Script</span>
        <span class="c"># Check for windows updates - Install Windows update module from PSGallery</span>
        <span class="c"># Reconfigure sysprep folder for actual install - New answer file, etc.</span>
        <span class="c"># ? Other Stuff?</span>
        <span class="c"># ? Disk clean up, remove old windows installs, etc.</span>
        <span class="c"># ? Figure out a way to get through multiple reboot automatically for updates</span>
        <span class="c"># Shutdown Image with generalize and sysprep ready to go</span>

    <span class="c"># Capture VHD to wim</span>
        <span class="c"># might need to do some fancy winpe stuff</span>

    <span class="c"># Test booting the image to verify successful configuration</span>
        <span class="c"># Verify sysprep processes correctly</span>
        <span class="c"># Verify start up scripts process correctly</span>

    <span class="c"># Clean up</span>
        <span class="c"># ? Maybe remove all Hyper-V stuff</span>
        <span class="c"># If using WDS, copy new image to WDS</span>
<span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.path", "navigation.top"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>