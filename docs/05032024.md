# May 3, 2024

## Current Project: Making a script to automate wim extraction and setup

**Problem to solve:** I need to recreate Windows images every quarter for
security and PCI compliance reasons. My current solution to this was to mount my
existing `install.wim` and boot it into audit mode, make whatever changes are
needed, and reapply any sysprep stuff, and recapture. This became very tedious
very fast with most of the steps being done manually.

**Goal:** I want to create a nice script to do most of the step for me. I will out line it first with my rough order and where I think the commands need to go for this process. Then I will slowly go through and actually uncomment the commands and make the thing real!

**Outline so far:**

```powershell

# Setup
$workingDirectory = 'C:\workingdirectory'
if (!(Test-Path -Path $workingDirectory -PathType Any)) {
    New-Item -Path $workingDirectory -ItemType Directory
    Write-Verbose -Message "The workingdirectory folder was not present. It has now been created. `
    In order for this process to continue successfully, the Drivers folder must be present and contain `
    any drivers that wish to be injected into the image, and the Windows 10 Enterprise LTSC iso file `
    to pull the image from. When this has been completed, restart this script."
}

$isoLocation = (Get-Item -Path 'C:\VM\regbaseimages\*LTSC*2021*.iso').FullName
if (!(Test-Path -Path $isoLocation -PathType Leaf)) {
    Write-Verbose -Message "Iso file is missing. copy SW_DVD9_WIN_ENT_LTSC_2021_64BIT_English_MLF_X22-84414.ISO into C:\workingdirectory and restart script."
    Return
}

$driverFolder = '$workingDirectory\Drivers'
if (!(Test-Path -Path '$driverFolder\*'-PathType Any)) {
    New-Item -Path $driverFolder -ItemType Directory
    Write-Verbose -Message "It looks like the driver folder is empty, add drivers and restart script"
    Return
}

# Mount iso file  
$locationInfo = (Mount-DiskImage -ImagePath $isoLocation -PassThru | Get-Volume)
$driveLetter = $locationInfo.DriveLetter+':\'
$devicePath = ($locationInfo | Get-DiskImage).DevicePath
$wimName = Win10Enterprise.wim

# Extract LTSC Edition from install.wim in sources directory to working directory
dism /Export-Image /SourceImageFile:$driveLetter\sources\install.wim /SourceIndex:1 /DestinationImageFile:$workingDirectory\$wimName

# Unmount iso file
Dismount-DiskImage -DevicePath $devicePath

# Rename the wim index to our own thing
    # Using dism run below
    # Imagex /info "<PATH TO IMAGE>" <Index Number> "<NEW IMAGE NAME>" "<NEW IMAGE DESCRIPTION>"
    # Impossible unless ran from the Deployment tools utility

# Mount wim file
New-Item -Path $workingDirectory -Name 'MountFolder' -ItemType Directory
Mount-WindowsImage -ImagePath $workingDirectory\$wimName -index 1 -path '$workingDirectory\MountFolder'
$mountFolder = '$workingDirectory\MountFolder'

# Inject device drivers
dism /Image:$mountFolder /Add-Driver /Driver:$driverFolder /Recurse

# Make Audit Mode answer file
    # To configure Windows to boot to audit mode, add the Microsoft-Windows-Deployment | Reseal | Mode = audit
    # Run script on first time start up

# Copy sysprep files into sysprep folder in image
    # Copy-Item

# Unmount wim file
    # Dismount-WindowsImage -path "<PATH TO MOUNT FOLDER>" -save

# Rename wim file
    # Rename-File -Path <path to install.wim> -NewName <New Name of wim>

# Hyper-V automated setup
    # Build Virtual Machine
    # ? Mount VHD 
    # ? Run Diskpart commands to format the drive correctly
    # ? Expand-WindowsImage and <cmd.exe /c "bcdboot W:\Windows /s S: /f ALL"> to apply wim to vhd drive
    # ? Unmount vhd drive
    # ? Assign vhd to Virtual Machine
    # ? Start Virtual Machine

# Boot Virtual Machine
    # Audit Mode boots automatically and runs Startup script

# In startup Script
    # Check for windows updates - Install Windows update module from PSGallery
    # Reconfigure sysprep folder for actual install - New answer file, etc.
    # ? Other Stuff?
    # ? Disk clean up, remove old windows installs, etc.
    # ? Figure out a way to get through multiple reboot automatically for updates
    # Shutdown Image with generalize and sysprep ready to go

# Capture VHD to wim
    # might need to do some fancy winpe stuff

# Test booting the image to verify successful configuration
    # Verify sysprep processes correctly
    # Verify start up scripts process correctly

# Clean up
    # ? Maybe remove all Hyper-V stuff
    # If using WDS, copy new image to WDS
```
