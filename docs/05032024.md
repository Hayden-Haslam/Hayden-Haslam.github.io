# May 3, 2024

## Current Project: Making a script to automate wim extraction and setup

**Problem to solve:** I need to recreate Windows images every quarter for
security and PCI compliance reasons. My current solution to this was to mount my
existing `install.wim` and boot it into audit mode, make whatever changes are
needed, and reapply any sysprep stuff, and recapture. This became very tedious
very fast with most of the steps being done manually.

**Goal:** I want to create a nice script to do most of the steps for me. I will
out line it first with my rough order and where I think the commands need to go
for this process. Then I will slowly go through and actually uncomment the
commands and make the thing real!

**Update #1:** As I've been working through this, I've made a lot of progress on
the logic of the script. I have also been trying to incorporate use of
`Write-Verbose` to leverage some verbose output for troubleshoot purposes, but I
am still a little confused on how it exactly works. So for now, disregard the
excessive amount for `Write-Verbose` lines.

```powershell
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ]"
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Starting Script."
# Setup
$workingDirectory = 'C:\workingdirectory'
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Setting Working Directory to $workingDirectory."
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Testing if $workingDirectoy exists."
if (!(Test-Path -Path $workingDirectory -PathType Any)) {
    Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] $workingDirectory does not exist, creating now."
    New-Item -Path 'C:\' -Name 'workingdirectory' -ItemType Directory
    Write-Warning -Message "The workingdirectory folder was not present. It has now been created. `
    In order for this process to continue successfully, the Drivers folder must be present and contain `
    any drivers that wish to be injected into the image, and the Windows 10 Enterprise LTSC iso file `
    to pull the image from. When this has been completed, restart this script."
}

$isoLocation = (Get-Item -Path 'C:\VM\regbaseimages\*LTSC*2021*.iso').FullName
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Setting ISO location: $isoLocation."
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Testing if ISO exists."
if (!(Test-Path -Path $isoLocation -PathType Leaf)) {
    Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] ISO does not exist, display Warning and exit."
    Write-Warning -Message "Iso file is missing. copy SW_DVD9_WIN_ENT_LTSC_2021_64BIT_English_MLF_X22-84414.ISO into C:\workingdirectory and restart script."
    Return
}

$driverFolder = $workingDirectory+'\Drivers'
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Setting Driver folder location: $driverFolder."
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Testing if Driver folder exists."
if (!(Test-Path -Path $driverFolder -PathType Any)) {
    Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] $driverFolder does not exits, creating now."
    New-Item -Path $workingDirectory'\' -Name 'Drivers' -ItemType Directory
    Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Display Warning and exit."
    Write-Warning -Message "It looks like the driver folder is empty, add drivers and restart script"
    Return
}

# Mount iso file
$locationInfo = (Mount-DiskImage -ImagePath $isoLocation -PassThru | Get-Volume)
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Mounting ISO for wim extraction."
$driveLetter = ($locationInfo).DriveLetter+':\'
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] ISO mounted at Driver Letter: $driveLetter"
$devicePath = ($locationInfo | Get-DiskImage).DevicePath
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] ISO mounted at Device Location: $devicePath"
$wimName = 'Win10Enterprise.wim'
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Setting extracted wim name: $wimName"

# Extract LTSC Edition from install.wim in sources directory to working directory
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Extracting Windows 10 LTSC version from install.wim to $workingDirectory"
Dism /Export-Image /SourceImageFile:$driveLetter\sources\install.wim /SourceIndex:1 /DestinationImageFile:$workingDirectory\$wimName

# Unmount iso file
Write-Verbose -Message "[ $((Get-Date).TimeOfDay.ToString()) ] Dismount ISO file from $devicePath"
Dismount-DiskImage -DevicePath $devicePath

# Rename the wim index to our own thing
    # Using dism run below
    # Imagex /info "<PATH TO IMAGE>" <Index Number> "<NEW IMAGE NAME>" "<NEW IMAGE DESCRIPTION>"
    # Impossible unless ran from the Deployment tools utility

# Mount wim file
New-Item -Path $workingDirectory -Name 'MountFolder' -ItemType Directory
$mountFolder = $workingDirectory+'\MountFolder'
$wimLocation = $workingDirectory+'\'+$wimName
Mount-WindowsImage -ImagePath $wimLocation -Index 1 -Path $mountFolder

# Inject device drivers
dism /Image:$mountFolder /Add-Driver /Driver:$driverFolder /Recurse

# Make Audit Mode answer file
    # To configure Windows to boot to audit mode, add the Microsoft-Windows-Deployment | Reseal | Mode = audit
    # Run script on first time start up
        # Install-Module -Name PSWindowsUpdate
        # Get-WindowsUpdate -AcceptAll

# Copy sysprep files into sysprep folder in image
    # Copy-Item

# Unmount wim file
Dismount-WindowsImage -path $mountFolder -save

# Rename wim file
    # Rename-File -Path <path to install.wim> -NewName <New Name of wim>

# Hyper-V automated setup
    # Build Virtual Machine
    # ? Mount VHD 
    # ? Run Diskpart commands to format the drive correctly
    # ? Expand-WindowsImage and <cmd.exe /c "bcdboot W:\Windows /s S: /f ALL"> to apply wim to vhd drive
    # ? Unmount vhd drive
    # ? Assign vhd to Virtual Machine
    # ? Start Virtual Machine

# Boot Virtual Machine
    # Audit Mode boots automatically and runs Startup script

# In startup Script
    # Check for windows updates - Install Windows update module from PSGallery
    # Reconfigure sysprep folder for actual install - New answer file, etc.
    # ? Other Stuff?
    # ? Disk clean up, remove old windows installs, etc.
    # ? Figure out a way to get through multiple reboot automatically for updates
    # Shutdown Image with generalize and sysprep ready to go

# Capture VHD to wim
    # might need to do some fancy winpe stuff

# Test booting the image to verify successful configuration
    # Verify sysprep processes correctly
    # Verify start up scripts process correctly

# Clean up
    # ? Maybe remove all Hyper-V stuff
    # If using WDS, copy new image to WDS
```
